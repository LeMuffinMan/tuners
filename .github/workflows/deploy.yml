name: Deploy Wasm tune.rs on GitHub Pages

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Add wasm target
        run: rustup target add wasm32-unknown-unknown

      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Cache build artifacts
        uses: actions/cache@v3
        with:
          path: target/
          key: ${{ runner.os }}-target-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-target-

      - name: Format test
        run: cargo fmt --all -- --check

      - name: Cargo check tuners_wasm
        run: cargo check -p tuners_wasm --target wasm32-unknown-unknown --profile wasm-release

      # - name: Cargo check tuners_native
      #   run: cargo check -p tuners_native

      # - name: Cargo check dsp
      #   run: cargo check -p dsp

      #cfg pour audio et gui ?

      - name: Run Clippy on WASM
        run: |
          cargo clippy -p tuners_wasm \
            --target wasm32-unknown-unknown \
            --profile wasm-release \
            -- -D warnings

      # - name: Run Clippy on workspace
      #   run: |
      #     cargo clippy --workspace \
      #       --exclude tuners_wasm \
      #       --all-targets \
      #       -- -D warnings

      #cfg for gui and audio ?

      - name: Install wasm-bindgen-cli
        run: |
          cargo install wasm-bindgen-cli --version 0.2.92 || true

      - name: Install wasm-opt (binaryen)
        run: |
          BINARYEN_VERSION=version_116
          wget -q https://github.com/WebAssembly/binaryen/releases/download/${BINARYEN_VERSION}/binaryen-${BINARYEN_VERSION}-x86_64-linux.tar.gz
          tar -xzf binaryen-${BINARYEN_VERSION}-x86_64-linux.tar.gz
          sudo cp binaryen-${BINARYEN_VERSION}/bin/wasm-opt /usr/local/bin/
          wasm-opt --version

      - name: Install Trunk || true
        run: cargo install --locked trunk

      - name: Build WASM (optimized)
        run: |
          cd crates/wasm
          trunk build --release --public-url "/${{ github.event.repository.name }}/"
        env:
          RUSTFLAGS: "-C target-feature=+simd128"

      - name: Optimize WASM with wasm-opt
        run: |
          cd crates/wasm/dist
          for wasm_file in *.wasm; do
            if [ -f "$wasm_file" ]; then
              echo "ðŸ”§ Optimizing $wasm_file..."

              SIZE_BEFORE=$(stat -c%s "$wasm_file")
              echo "  Before: $((SIZE_BEFORE / 1024)) KB"

              wasm-opt -Oz \
                --enable-bulk-memory \
                --enable-simd \
                --enable-reference-types \
                --strip-debug \
                --strip-producers \
                "$wasm_file" \
                -o "${wasm_file}.opt"

              mv "${wasm_file}.opt" "$wasm_file"

              SIZE_AFTER=$(stat -c%s "$wasm_file")
              REDUCTION=$((100 - (SIZE_AFTER * 100 / SIZE_BEFORE)))
              echo "  After:  $((SIZE_AFTER / 1024)) KB (-${REDUCTION}%)"
            fi
          done

      - name: Generate size report
        run: |
          cd crates/wasm/dist

          echo "ðŸ“Š WASM Bundle Size Report" > size-report.txt
          echo "=============================" >> size-report.txt
          echo "" >> size-report.txt

          for wasm_file in *.wasm; do
            if [ -f "$wasm_file" ]; then
              SIZE=$(stat -c%s "$wasm_file")
              SIZE_KB=$((SIZE / 1024))

              gzip -c "$wasm_file" > "${wasm_file}.gz"
              SIZE_GZ=$(stat -c%s "${wasm_file}.gz")
              SIZE_GZ_KB=$((SIZE_GZ / 1024))
              rm "${wasm_file}.gz"

              echo "File: $wasm_file" >> size-report.txt
              echo "  Uncompressed: ${SIZE_KB} KB" >> size-report.txt
              echo "  Gzipped:      ${SIZE_GZ_KB} KB" >> size-report.txt
              echo "" >> size-report.txt
            fi
          done

          cat size-report.txt

          echo "## ðŸ“¦ WASM Bundle Size" >> $GITHUB_STEP_SUMMARY
          cat size-report.txt >> $GITHUB_STEP_SUMMARY

      - name: Deploy
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./crates/wasm/dist

      - name: Deployment summary
        run: |
          echo "## âœ… Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ Live at: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Optimizations Applied:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Rust profile: \`wasm-release\` (opt-level=z)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… LTO: enabled (fat)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… SIMD: enabled (+simd128)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… wasm-opt: -Oz optimization" >> $GITHUB_STEP_SUMMARY
